name: Release Debian Package

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-deb:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential debhelper devscripts python3 python3-setuptools dh-python python3-all

    - name: Install PySide6 dependencies
      run: |
        # Update package lists to ensure we have the latest package information
        sudo apt update

        # Try to install PySide6 packages (available in Debian testing/unstable)
        # If not available, fall back to pip installation
        if apt-cache show python3-pyside6.qtcore >/dev/null 2>&1 && \
           apt-cache show python3-pyside6.qtgui >/dev/null 2>&1 && \
           apt-cache show python3-pyside6.qtqml >/dev/null 2>&1 && \
           apt-cache show python3-pyside6.qtquick >/dev/null 2>&1; then
          echo "Installing PySide6 from apt repositories..."
          sudo apt install -y python3-pyside6.qtcore python3-pyside6.qtgui python3-pyside6.qtwidgets python3-pyside6.qtqml python3-pyside6.qtquick python3-pyside6.qtnetwork python3-pyside6.qtopengl || {
            echo "Apt installation failed, falling back to pip..."
            pip3 install PySide6
          }
        else
          echo "PySide6 packages not fully available in apt, installing via pip..."
          pip3 install PySide6
        fi

    - name: Install Android tools
      run: |
        sudo apt install -y android-tools-adb

    - name: Build Debian package
      run: |
        dpkg-buildpackage -us -uc -b

    - name: Prepare artifacts
      run: |
        cp ../*.deb . 2>/dev/null || true
        cp ../*.buildinfo . 2>/dev/null || true
        cp ../*.changes . 2>/dev/null || true
        ls -la *.deb *.buildinfo *.changes

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: debian-package
        path: |
          *.deb
          *.buildinfo
          *.changes

    - name: Create Nightly Tag
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        # Create a lightweight tag for nightly release
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git tag "nightly-${{ github.run_number }}-${{ github.run_attempt }}" ${{ github.sha }}

    - name: Debug Branch Info
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "Branch: ${{ github.ref }}"
        echo "Ref name: ${{ github.ref_name }}"
        echo "Run number: ${{ github.run_number }}"
        echo "Run attempt: ${{ github.run_attempt }}"
        echo "Will create nightly release"

    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: nightly-${{ github.run_number }}-${{ github.run_attempt }}
        name: Nightly Release ${{ github.run_number }}.${{ github.run_attempt }}
        body: |
          ## Unified Mobile Controller (UMC) - Nightly Build

          This is an automated nightly release built from the latest `${{ github.ref_name }}` branch changes.

          ### What's Included
          - **Latest features** and bug fixes from ongoing development
          - **Pre-compiled Debian package** for easy installation
          - **Build artifacts** including debug symbols and build info

          ### Installation
          ```bash
          # Download and install
          wget https://github.com/${{ github.repository }}/releases/download/nightly-${{ github.run_number }}-${{ github.run_attempt }}/umc_*.deb
          sudo dpkg -i umc_*.deb
          sudo apt install -f
          ```

          ### Build Information
          - **Commit**: [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          - **Branch**: `${{ github.ref_name }}`
          - **Build Date**: ${{ github.event.head_commit.timestamp }}
          - **CI Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### ⚠️ Pre-release Notice
          This is a development build that may contain:
          - Unstable features
          - Potential bugs
          - Incomplete documentation

          For stable releases, see the [official releases](https://github.com/${{ github.repository }}/releases) page.

          ---
          *This release was automatically created by GitHub Actions CI/CD pipeline.*
        files: |
          *.deb
          *.buildinfo
          *.changes
        draft: false
        prerelease: true
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
      continue-on-error: true

    - name: Release Status
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "Build completed successfully!"
        echo "Debian packages available in workflow artifacts"
        echo ""
        echo "If release creation failed (403 Forbidden):"
        echo ""
        echo "REQUIRED FIX: Update Repository Permissions"
        echo "Steps:"
        echo "   1. Go to repository Settings > Actions > General"
        echo "   2. Set 'Workflow permissions' to 'Read and write permissions'"
        echo "   3. Check 'Allow GitHub Actions to create and approve pull requests'"
        echo "   4. Save and push another commit to test"
        echo ""
        echo "Alternative: Create RELEASE_TOKEN secret with a Personal Access Token"
        echo ""
        echo "Packages are always available in: Actions > This workflow > Artifacts"

    - name: Cleanup Nightly Tag
      if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        # Remove the temporary nightly tag (local only, not pushed)
        git tag -d "nightly-${{ github.run_number }}-${{ github.run_attempt }}" || true

    - name: Create Tagged Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          ## Unified Mobile Controller (UMC) - ${{ github.ref_name }}

          Official stable release of Unified Mobile Controller.

          ### What's New
          See the automatically generated release notes below for a complete list of changes, features, and bug fixes included in this release.

          ### Installation
          ```bash
          # Download and install the Debian package
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/umc_*.deb
          sudo dpkg -i umc_*.deb
          sudo apt install -f

          # Or install from source
          git clone https://github.com/${{ github.repository }}.git
          cd ${{ github.event.repository.name }}
          pip install -r requirements.txt
          python main.py
          ```

          ### System Requirements
          - **OS**: Linux (Ubuntu/Debian recommended)
          - **Python**: 3.10 or higher
          - **Tools**: ADB, Scrcpy
          - **Display**: X11 or Wayland

          ### Package Contents
          - Pre-compiled application binary
          - PySide6 GUI framework
          - Desktop integration files
          - System shortcuts and documentation

          ### Verification
          - **SHA256 checksums** are available in the build artifacts
          - **Build logs** can be viewed in the [Actions tab](${{ github.server_url }}/${{ github.repository }}/actions)

          ### Support
          - **Documentation**: [README.md](${{ github.server_url }}/${{ github.repository }}/blob/main/README.md)
          - **Issues**: [GitHub Issues](${{ github.server_url }}/${{ github.repository }}/issues)
          - **Discussions**: [GitHub Discussions](${{ github.server_url }}/${{ github.repository }}/discussions)

          ---
          *Released on ${{ github.event.head_commit.timestamp }} | Built by GitHub Actions*
        files: |
          *.deb
          *.buildinfo
          *.changes
        generate_release_notes: true
        draft: false
        prerelease: false
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}