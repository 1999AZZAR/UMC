name: Release Debian Package

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-deb:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential debhelper devscripts python3 python3-setuptools dh-python python3-all

    - name: Install PySide6 dependencies
      run: |
        # Update package lists to ensure we have the latest package information
        sudo apt update

        # Try to install PySide6 packages (available in Debian testing/unstable)
        # If not available, fall back to pip installation
        if apt-cache show python3-pyside6.qtcore >/dev/null 2>&1 && \
           apt-cache show python3-pyside6.qtgui >/dev/null 2>&1 && \
           apt-cache show python3-pyside6.qtqml >/dev/null 2>&1 && \
           apt-cache show python3-pyside6.qtquick >/dev/null 2>&1; then
          echo "Installing PySide6 from apt repositories..."
          sudo apt install -y python3-pyside6.qtcore python3-pyside6.qtgui python3-pyside6.qtwidgets python3-pyside6.qtqml python3-pyside6.qtquick python3-pyside6.qtnetwork python3-pyside6.qtopengl || {
            echo "Apt installation failed, falling back to pip..."
            pip3 install PySide6
          }
        else
          echo "PySide6 packages not fully available in apt, installing via pip..."
          pip3 install PySide6
        fi

    - name: Install Android tools
      run: |
        sudo apt install -y android-tools-adb

    - name: Build Debian package
      run: |
        dpkg-buildpackage -us -uc -b

    - name: Prepare artifacts
      run: |
        cp ../*.deb . 2>/dev/null || true
        cp ../*.buildinfo . 2>/dev/null || true
        cp ../*.changes . 2>/dev/null || true
        ls -la *.deb *.buildinfo *.changes

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: debian-package
        path: |
          *.deb
          *.buildinfo
          *.changes

    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: nightly-${{ github.run_number }}
        name: Nightly Release ${{ github.run_number }}
        body: |
          Automated nightly release from ${{ github.ref_name }} branch.

          ## Changes
          - Automated build from commit: ${{ github.sha }}
          - Built on: ${{ github.event.head_commit.timestamp }}

          ## Downloads
          - Download the .deb package from the assets below
        files: |
          *.deb
          *.buildinfo
          *.changes
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Tagged Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          Official release ${{ github.ref_name }}

          ## Downloads
          - Download the .deb package from the assets below
        files: |
          *.deb
          *.buildinfo
          *.changes
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}